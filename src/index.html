<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>TubeTally — Irrigation Row Counter</title>
  <meta name="theme-color" content="#10B981" />
  <link rel="manifest" href="./manifest.json" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="./icon.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --green: #10B981;
      --red: #EF4444;
      --yellow: #F59E0B;
      --bg: #ffffff;
      --fg: #111827;
      --card: #ffffff;
      --cardBorder: #e5e7eb;
    }

    .dark {
      --bg: #0b0b0c;
      --fg: #e5e7eb;
      --card: #141417;
      --cardBorder: #26272b;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: var(--bg);
      color: var(--fg);
      overflow: hidden;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100svh;
      padding-bottom: env(safe-area-inset-bottom);
    }

    #mainContent {
      display: flex;
      flex: 1;
      overflow: hidden;
      gap: 1rem;
      padding: 0 1rem 1rem 1rem;
    }

    .column {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    #app.flip-layout #mainContent {
      flex-direction: row-reverse;
    }

    .btn {
      border-radius: 1rem;
      font-weight: 800;
      box-shadow: 0 6px 14px rgba(0, 0, 0, .08);
      transition: transform .05s;
    }

    .btn:active {
      transform: scale(.98);
    }

    .icon-btn {
      border-radius: .75rem;
      background: #f3f4f6;
      color: #111827;
      padding: .5rem .75rem;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .dark .icon-btn {
      background: #1f2937;
      color: #f3f4f6;
    }

    .card {
      border: 1px solid var(--cardBorder);
      background: var(--card);
      border-radius: 1rem;
    }

    /* History row styles: fixed-width right-aligned numbers and non-wrapping status badges */
    .history-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .history-number {
      width: 3ch;
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Segoe UI Mono', monospace;
    }

    .history-badge {
      display: inline-block;
      white-space: nowrap;
      padding: .25rem .6rem;
      font-weight: 700;
      border-radius: .5rem;
      font-size: .95rem;
    }

    /* Compact stat badges shown under history: 3-digit padded numbers */
    .stat-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 3ch;
      padding: .12rem .4rem;
      border-radius: .5rem;
      font-weight: 800;
      font-size: .95rem;
      white-space: nowrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Segoe UI Mono', monospace;
    }

    #toast {
      position: fixed;
      left: 50%;
      bottom: calc(env(safe-area-inset-bottom) + 12px);
      transform: translateX(-50%);
      background: #111827;
      color: #fff;
      padding: .55rem .8rem;
      border-radius: .75rem;
      font-size: .875rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s;
      z-index: 50;
    }

    .show {
      opacity: 1;
    }
  </style>
</head>

<body>
  <div id="app" class="select-none">
    <!-- TOP BAR -->
    <header class="flex justify-between items-center p-3 flex-none">
      <div class="flex items-center gap-2">
        <img src="./icon.svg" alt="TubeTally" class="w-8 h-8" />
        <h1 class="text-xl font-extrabold">TubeTally <span id="appVersionLabel" class="text-xs font-normal align-top opacity-60">v1.6</span></h1>
      </div>
      <div class="flex items-center gap-4">
        <button id="shareBtn" class="icon-btn" title="Share report" aria-label="Share">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
          <span class="hidden sm:inline">Share</span>
        </button>
        <button id="resetBtn" class="icon-btn" title="Reset" aria-label="Reset">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="1 4 1 10 7 10"></polyline>
            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
          </svg>
          <span class="hidden sm:inline">Reset</span>
        </button>
        <button id="settingsBtn" class="icon-btn" title="Settings" aria-label="Settings">Settings</button>
        <button id="installBtn" class="icon-btn hidden" title="Install app" aria-label="Install app">Install</button>
      </div>
    </header>

    <!-- META ROW -->
    <section id="meta" class="px-4 text-sm flex-none">
      <div class="flex flex-wrap items-center gap-x-2 gap-y-1">
        <span class="opacity-70">Field:</span>
        <span id="fieldNameLabel" class="font-semibold">—</span>
        <span class="mx-2 opacity-30">·</span>
        <span class="opacity-70">Started:</span>
        <span id="startedAt" class="font-mono">—</span>
      </div>
    </section>

    <!-- MAIN CONTENT (2 COLUMNS) -->
    <div id="mainContent">
      <!-- LEFT COLUMN -->
      <div class="column">
        <!-- HISTORY -->
        <section id="historyWrap" class="flex flex-col flex-1 overflow-hidden">
          <h2 class="font-semibold mt-1 mb-2 flex-none">History</h2>
          <div id="history" class="flex-1 overflow-y-auto card p-2"></div>

          <!-- History stats: compact single-row numeric badges (Not Done / Done / Almost Done) -->
          <div id="historyStats" class="mt-3 text-sm">
            <div class="flex items-center gap-3">
              <div class="flex items-center gap-2">
                <span id="countNotDone" class="stat-badge bg-[color:var(--red)] text-white">0</span>
                <span id="countDone" class="stat-badge bg-[color:var(--green)] text-white">0</span>
                <span id="countAlmost" class="stat-badge bg-[color:var(--yellow)] text-white">0</span>
              </div>
            </div>
          </div>
        </section>
        <!-- BACK BUTTON -->
        <button id="btnBack" class="btn bg-purple-600 text-white h-16 text-2xl py-3 mt-2 flex-none">BACK</button>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="column">
        <!-- CURRENT ROW -->
        <section id="currentWrap" class="flex flex-col items-center justify-center text-center flex-none mb-2">
          <div class="opacity-70 text-sm">Current Row</div>
          <div id="currentRow" class="text-4xl font-extrabold">1</div>
        </section>

        <!-- PRIMARY BUTTONS -->
        <section id="primaryWrap" class="grid grid-cols-1 gap-3 flex-1 overflow-hidden">
          <button id="btnNotDone" class="btn bg-[color:var(--red)] text-white h-full text-4xl py-4">NOT DONE</button>
          <button id="btnDone" class="btn bg-[color:var(--green)] text-white h-full text-4xl py-4">DONE</button>
        </section>

        <!-- ALMOST DONE BUTTON -->
        <button id="btnAlmost" class="btn bg-[color:var(--yellow)] text-white h-16 text-2xl py-3 mt-3 flex-none">ALMOST DONE</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS DIALOG -->
  <dialog id="settingsDialog" class="rounded-2xl p-0 w-[28rem] max-w-[95vw]">
    <form id="settingsForm" class="p-5 space-y-4">
      <div class="text-lg font-bold">Settings</div>
      <div class="grid grid-cols-2 gap-4">
      <label class="flex items-center gap-2"><input id="hapticToggle" type="checkbox"
        class="w-5 h-5" /><span>Vibration</span></label>
      <label class="flex items-center gap-2"><input id="beepToggle" type="checkbox"
        class="w-5 h-5" /><span>Beep</span></label>
      <label class="flex items-center gap-2 col-span-2"><input id="wakeToggle" type="checkbox"
        class="w-5 h-5" /><span>Keep screen awake</span></label>
      <label class="flex items-center gap-2 col-span-2"><input id="darkToggle" type="checkbox"
        class="w-5 h-5" /><span>Dark theme</span></label>
      <label class="flex items-center gap-2 col-span-2"><input id="leftHandedToggle" type="checkbox"
        class="w-5 h-5" /><span>Left-handed layout</span></label>
      </div>
      <div class="flex items-center justify-end pt-2">
        <div class="flex items-center gap-2">
          <button type="button" class="icon-btn" onclick="settingsDialog.close()">Cancel</button>
          <button class="icon-btn bg-gray-900 text-white">Save</button>
        </div>
      </div>
      <div class="text-xs opacity-60 mt-2" id="settingsVersionLabel"></div>
    </form>
  </dialog>

  <!-- Field name dialog (opened by clicking the field label) -->
  <dialog id="fieldNameDialog" class="rounded-2xl p-0 w-[22rem] max-w-[95vw]">
    <form id="fieldNameForm" class="p-5 space-y-4">
      <div class="text-lg font-bold">Field Name</div>
      <label class="block">
        <input id="fieldNameDialogInput" class="mt-1 w-full rounded-xl border border-gray-300 p-3 bg-white text-black" placeholder="e.g., West 40 — Block A" />
      </label>
      <div class="flex items-end justify-end gap-2">
        <button type="button" class="icon-btn" onclick="fieldNameDialog.close()">Cancel</button>
        <button class="icon-btn bg-gray-900 text-white">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Reset confirmation dialog -->
  <dialog id="resetConfirmDialog" class="rounded-2xl p-0 w-[24rem] max-w-[95vw]">
    <form method="dialog" class="p-5 space-y-4">
      <div class="text-lg font-bold">Reset data?</div>
      <p class="text-sm opacity-70">This will clear all logged rows. Your field name and preferences will be saved.</p>
      <div class="flex gap-2 justify-end">
        <button type="button" class="icon-btn" onclick="resetConfirmDialog.close()">Cancel</button>
        <button type="submit" class="icon-btn bg-red-600 text-white" value="confirm">Reset</button>
      </div>
    </form>
  </dialog>

  <!-- Toast (non-blocking) -->
  <div id="toast" role="status" aria-live="polite">Copied to clipboard</div>

  <script>
    const STORAGE_KEY = 'tubetally.v1';
    const $ = s => document.querySelector(s);
    
    const nowLocalISO = () => { const d = new Date(); const p = n => String(n).padStart(2, '0'); return `${d.getFullYear()}-${p(d.getMonth() + 1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}` };

    // ---------- Audio ----------
    let audioCtx = null;
    function ensureAudio() { if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch { } } if (audioCtx?.state === 'suspended') { audioCtx.resume?.(); } }
    function beep(freq = 440, dur = 90) { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = 'sine'; o.frequency.value = freq; o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.06, audioCtx.currentTime); o.start(); setTimeout(() => { o.stop(); }, dur); }

    // ---------- Haptic ----------
    function vib(pattern) { if (!state.prefs.haptic) return; if (navigator.vibrate) navigator.vibrate(pattern); }
    const hapticPattern = { DONE: [20, 40, 20], 'NOT DONE': [80], 'ALMOST DONE': [40, 30, 40], UNDO: [30, 20, 30] };

    // ---------- Wake Lock ----------
    let wakeLock = null; async function updateWakeLock() { try { if (state.prefs.wake) { wakeLock = await navigator.wakeLock?.request('screen'); wakeLock?.addEventListener?.('release', () => { }); } else { await wakeLock?.release?.(); wakeLock = null; } } catch { } }
    document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') updateWakeLock(); });

    // ---------- State ----------
    const initial = { fieldName: '', startedAt: '', currentRow: 1, rows: {}, actions: [], prefs: { haptic: true, beep: true, wake: true, dark: false, leftHanded: false } };
    let state = load();
    function load() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { ...initial, startedAt: nowLocalISO() }; } catch { return { ...initial, startedAt: nowLocalISO() }; } }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // ---------- Layout calculation ----------
    function layout() {
      // Layout is now handled by flexbox, no complex calculations needed
    }
    window.addEventListener('resize', layout);
    window.addEventListener('orientationchange', () => setTimeout(layout, 200));

    // ---------- Render ----------
    function render() {
      document.documentElement.classList.toggle('dark', !!state.prefs.dark);
      document.getElementById('app').classList.toggle('flip-layout', !!state.prefs.leftHanded);
      $('#currentRow').textContent = state.currentRow;
      $('#fieldNameLabel').textContent = state.fieldName || '—';
      $('#startedAt').textContent = state.startedAt || '—';
      const counts = { DONE: 0, 'NOT DONE': 0, 'ALMOST DONE': 0 };
      const h = $('#history'); h.innerHTML = '';
      const keys = Object.keys(state.rows).map(Number).sort((a, b) => a - b);
      for (const n of keys) {
        const st = state.rows[n];
        if (counts[st] !== undefined) counts[st]++;
        const c = st === 'DONE' ? 'bg-[color:var(--green)]' : st === 'NOT DONE' ? 'bg-[color:var(--red)]' : 'bg-[color:var(--yellow)]';
        const d = document.createElement('div');
        d.className = 'border-b' + (document.documentElement.classList.contains('dark') ? ' border-gray-700' : ' border-gray-200') + ' py-2';
        // pad number to 3 digits (non-breaking spaces) and right-align, make badge non-wrapping
        const num = String(n).padStart(3, '\u00A0');
        d.innerHTML = `<div class='history-row w-full'><span class='history-number font-mono opacity-70'>${num}:</span><span class='history-badge text-white ${c}'>${st}</span></div>`;
        h.appendChild(d);
      }
      h.scrollTop = h.scrollHeight;

      // update the small stats under the history
      const elNot = document.getElementById('countNotDone');
      const elDone = document.getElementById('countDone');
      const elAlmost = document.getElementById('countAlmost');
      if (elNot) elNot.textContent = String(counts['NOT DONE'] || 0).padStart(3, '\u00A0');
      if (elDone) elDone.textContent = String(counts['DONE'] || 0).padStart(3, '\u00A0');
      if (elAlmost) elAlmost.textContent = String(counts['ALMOST DONE'] || 0).padStart(3, '\u00A0');

      layout();
    }

    // ---------- Actions ----------
    function record(status) { ensureAudio(); if (state.prefs.haptic) vib(hapticPattern[status]); if (state.prefs.beep && audioCtx) beep(status === 'DONE' ? 700 : status === 'NOT DONE' ? 300 : 520, 100); state.rows[state.currentRow] = status; state.actions.push(state.currentRow); state.currentRow++; save(); render(); }
    function undo() { ensureAudio(); const last = state.actions.pop(); if (!last) return; if (state.prefs.haptic) vib(hapticPattern.UNDO); if (state.prefs.beep && audioCtx) beep(250, 110); delete state.rows[last]; state.currentRow = last; save(); render(); }

    // Long-press to test tone/haptic without recording
    function addHoldTest(el, status) {
      let t = null; el.addEventListener('pointerdown', () => { t = setTimeout(() => { ensureAudio(); if (state.prefs.haptic) vib(hapticPattern[status]); if (state.prefs.beep && audioCtx) beep(status === 'DONE' ? 700 : status === 'NOT DONE' ? 300 : 520, 200); t = null; }, 550); }, { passive: true });
      ['pointerup', 'pointercancel', 'pointerleave'].forEach(ev => el.addEventListener(ev, () => { if (t) { clearTimeout(t); t = null; } }, { passive: true }));
    }

    // ---------- Report ----------
    function buildReport() {
      const b = { 'DONE': [], 'ALMOST DONE': [], 'NOT DONE': [] };
      for (const [k, v] of Object.entries(state.rows)) if (b[v]) b[v].push(+k);
      for (const k in b) b[k].sort((a, b) => a - b);
      const cD = b['DONE'].length, cA = b['ALMOST DONE'].length, cN = b['NOT DONE'].length;
      const header = `Field: ${state.fieldName || '—'}\nDate: ${nowLocalISO()}`;
      const body = [`DONE (${cD} rows): ${b['DONE'].join(', ')}`, '', `ALMOST DONE (${cA} rows): ${b['ALMOST DONE'].join(', ')}`, '', `NOT DONE (${cN} rows): ${b['NOT DONE'].join(', ')}`].join('\n');
      return `${header}\n\n${body}`;
    }

    // Share: native sheet when available; else copy silently with toast (no blocking prompts)
    async function shareReport() { const text = buildReport(); if (navigator.share) { try { await navigator.share({ title: 'TubeTally Report', text }); return; } catch { return; } } try { await navigator.clipboard.writeText(text); showToast('Copied to clipboard'); } catch { /* ignore */ } }

    function showToast(msg) { const el = $('#toast'); el.textContent = msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 1500); }

    // Reset: clears rows/actions and storage; preserves prefs & field name
    function resetNow() { state = { ...initial, fieldName: state.fieldName, startedAt: nowLocalISO(), prefs: { ...state.prefs }, rows: {}, actions: [] }; try { localStorage.removeItem(STORAGE_KEY); } catch { } save(); render(); }

    // ---------- Bindings ----------
    $('#btnDone').onclick = () => record('DONE');
    $('#btnNotDone').onclick = () => record('NOT DONE');
    $('#btnAlmost').onclick = () => record('ALMOST DONE');
    $('#btnBack').onclick = () => undo();
    addHoldTest($('#btnDone'), 'DONE');
    addHoldTest($('#btnNotDone'), 'NOT DONE');
    addHoldTest($('#btnAlmost'), 'ALMOST DONE');

    $('#shareBtn').onclick = () => { ensureAudio(); shareReport(); };
    
    // Reset button: show confirmation dialog instead of immediately resetting
    const resetConfirmDialog = document.getElementById('resetConfirmDialog');
    $('#resetBtn').onclick = () => {
      resetConfirmDialog.showModal();
    };
    resetConfirmDialog.addEventListener('close', (e) => {
      if (resetConfirmDialog.returnValue === 'confirm') {
        resetNow();
        showToast('Data reset');
      }
    });

    // Settings dialog
    const settingsDialog = document.getElementById('settingsDialog');
    $('#settingsBtn').onclick = () => {
      $('#hapticToggle').checked = !!state.prefs.haptic;
      $('#beepToggle').checked = !!state.prefs.beep;
      $('#wakeToggle').checked = !!state.prefs.wake;
      $('#darkToggle').checked = !!state.prefs.dark;
      $('#leftHandedToggle').checked = !!state.prefs.leftHanded;
      settingsDialog.showModal();
    };
    document.getElementById('settingsForm').addEventListener('submit', (e) => {
      e.preventDefault();
      state.prefs.haptic = $('#hapticToggle').checked;
      state.prefs.beep = $('#beepToggle').checked;
      state.prefs.wake = $('#wakeToggle').checked;
      state.prefs.dark = $('#darkToggle').checked;
      state.prefs.leftHanded = $('#leftHandedToggle').checked;
      if (!state.startedAt) state.startedAt = nowLocalISO();
      save(); render(); settingsDialog.close(); updateWakeLock();
    });

    // Field name dialog bindings (opened by clicking the field label)
    const fieldNameDialog = document.getElementById('fieldNameDialog');
    // also expose on window so inline onclick="fieldNameDialog.close()" works
    window.fieldNameDialog = fieldNameDialog;
    const fieldNameInputDialog = document.getElementById('fieldNameDialogInput');
    document.getElementById('fieldNameLabel').addEventListener('click', () => {
      fieldNameInputDialog.value = state.fieldName || '';
      fieldNameDialog.showModal();
    });
    document.getElementById('fieldNameForm').addEventListener('submit', (e) => {
      e.preventDefault();
      state.fieldName = fieldNameInputDialog.value.trim();
      if (!state.startedAt) state.startedAt = nowLocalISO();
      save(); render(); fieldNameDialog.close();
    });

    // Prime audio on first interaction
    document.addEventListener('touchstart', ensureAudio, { once: true });
    document.addEventListener('mousedown', ensureAudio, { once: true });

    render();
    updateWakeLock();

    // load version from single source (src/version.json)
    (async function loadVersion(){
      try {
        const res = await fetch('./version.json', {cache: 'no-store'});
        if (!res.ok) return;
        const data = await res.json();
        const ver = data.version || '';
        const appVerEl = document.getElementById('appVersionLabel');
        const settingsVerEl = document.getElementById('settingsVersionLabel');
        if (appVerEl) appVerEl.textContent = ver;
        if (settingsVerEl) settingsVerEl.textContent = ver;
      } catch (err) {
        console.warn('Failed to load version.json', err);
      }
    })();
  </script>
  <script>
    // Register service worker for offline support and installability
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').then(() => {
        console.log('Service worker registered');
      }).catch((err) => {
        console.warn('Service worker registration failed:', err);
      });
    }

    // Optional: capture install prompt for custom UI and wire the Install button
    window.deferredPrompt = null;
    const installBtnEl = document.getElementById('installBtn');
    if (installBtnEl) {
      installBtnEl.addEventListener('click', async () => {
        if (!window.deferredPrompt) return;
        window.deferredPrompt.prompt();
        try {
          const choice = await window.deferredPrompt.userChoice;
          if (choice.outcome === 'accepted') showToast('App installed'); else showToast('Install dismissed');
        } catch (err) {
          console.warn('install prompt error', err);
        }
        window.deferredPrompt = null;
        installBtnEl.classList.add('hidden');
      });
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      window.deferredPrompt = e;
      if (installBtnEl) installBtnEl.classList.remove('hidden');
      console.log('beforeinstallprompt captured');
    });

    window.addEventListener('appinstalled', (e) => {
      window.deferredPrompt = null;
      if (installBtnEl) installBtnEl.classList.add('hidden');
      showToast('App installed');
    });
  </script>
</body>

</html>